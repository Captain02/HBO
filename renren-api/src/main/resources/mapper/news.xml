<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="news">
    <resultMap id="newslist" type="io.renren.common.entity.PageData">
        <id column="id" property="id"></id>
        <association property="likeusers" column="id" select="selectlikesUser"></association>
        <association property="replicenum" column="id" select="replicenum"></association>
    </resultMap>

    <resultMap id="detail" type="io.renren.common.entity.PageData">
        <id column="id" property="id"></id>
        <association property="user" column="{id=user_id}" select="io.renren.modules.login.dao.UserDao.getinfoByIdNotContentRoleDept"></association>
        <association property="likeusers" column="id" select="selectlikesUser"></association>
        <association property="replicenum" column="id" select="replicenum"></association>
    </resultMap>

    <resultMap id="newsReplice" type="io.renren.common.entity.PageData">
        <id column="id" property="id"></id>
        <association property="RepliceUser" select="io.renren.modules.login.dao.UserDao.getinfoByIdNotContentRoleDept" column="{id=userid}"></association>
        <association property="ReplicedUser" select="io.renren.modules.login.dao.UserDao.getinfoByIdNotContentRoleDept" column="{id=repliesuserid}"></association>
        <association property="likenum" column="id" select="selectlikenum"></association>
        <collection property="likeuser" column="id" select="selectlikeuser"></collection>
        <collection property="getNewsReplice" column="{topicid=topicid,parentid=id}" select="getNewNewsReplice"></collection>
    </resultMap>

    <select id="newlistPage" resultMap="newslist">
        SELECT
        actnews.`id`,actnews.`corid`,actnews.`content`,actnews.`createtime`,
        actnews.`deptid`,actnews.`title`,actnews.`releaseuser`,actnews.`imageid`,
        corporation.`corname`,sys_dept.`name`,filetable.`filepath`,
        sys_user.`user_id`,sys_user.`name` persionname
        FROM actnews
        LEFT JOIN corporation ON corporation.`id` = actnews.`corid`
        LEFT JOIN sys_dept ON sys_dept.`dept_id` = actnews.`deptid`
        LEFT JOIN filetable ON filetable.`id` = actnews.`imageid`
        LEFT JOIN sys_user ON sys_user.`user_id` = actnews.`releaseuser`
        WHERE isnews = 1
        ORDER BY actnews.`id` DESC
    </select>
    <select id="replicenum" resultType="io.renren.common.entity.PageData">
        SELECT count(*) num
        FROM news_replies
        WHERE news_replies.`topicid` = #{id}
    </select>
    <select id="selectlikeUser" resultType="io.renren.common.entity.PageData">
        SELECT
        sys_user.`user_id`
        FROM sys_user
        LEFT JOIN news_like ON news_like.`userid` = sys_user.`user_id`
        WHERE topicid = #{id}
    </select>
    <select id="selectlikesUser" resultType="io.renren.common.entity.PageData">
        SELECT count(*) num
        FROM news_like
        WHERE news_like.`topicid` = #{id}

    </select>

    <select id="getNewsDetail" resultMap="detail">
        SELECT
        actnews.`id`,actnews.`corid`,actnews.`content`,actnews.`createtime`,
        actnews.`deptid`,actnews.`title`,actnews.`releaseuser`,actnews.`imageid`,
        corporation.`corname`,sys_dept.`name`,filetable.`filepath`,
        sys_user.`user_id`,sys_user.`name` persionname
        FROM actnews
        LEFT JOIN corporation ON corporation.`id` = actnews.`corid`
        LEFT JOIN sys_dept ON sys_dept.`dept_id` = actnews.`deptid`
        LEFT JOIN filetable ON filetable.`id` = actnews.`imageid`
        LEFT JOIN sys_user ON sys_user.`user_id` = actnews.`releaseuser`
        WHERE actnews.`id` = #{id}
    </select>

    <select id="getNewsReplicelistPage" resultMap="newsReplice">
        SELECT news_replies.`id`,news_replies.`userid`,news_replies.`parentid`,
        news_replies.`topicid`,news_replies.`createtime`,
        news_replies.`repliescontent`,news_replies.`repliesuserid`,news_replies.`states`
        FROM news_replies
        WHERE news_replies.`topicid` = #{pd.topicid} AND news_replies.`parentid` = #{pd.parentid}
    </select>
    <select id="getNewNewsReplice" resultMap="newsReplice">
        SELECT news_replies.`id`,news_replies.`userid`,news_replies.`parentid`,
        news_replies.`topicid`,news_replies.`createtime`,
        news_replies.`repliescontent`,news_replies.`repliesuserid`,news_replies.`states`
        FROM news_replies
        WHERE news_replies.`topicid` = #{topicid} AND news_replies.`parentid` = #{parentid}
    </select>
    <select id="selectlikenum" resultType="io.renren.common.entity.PageData">
        SELECT count(*) num FROM bbs_replies_like WHERE repliesid = #{id}
    </select>
    <select id="selectlikeuser" resultType="io.renren.common.entity.PageData">
        SELECT userid FROM bbs_replies_like WHERE repliesid = #{id}
    </select>
    <insert id="replies">
        insert into news_replies (userid,parentid,topicid,repliescontent,repliesuserid)
         values (#{userid},#{parentid},#{topicid},#{repliescontent},#{repliesuserid});
    </insert>
    <insert id="likeTopic">
        insert into news_like (userid,topicid) values (#{userid},#{topicid});
    </insert>
    <delete id="unlikeTopic">
        DELETE FROM news_like WHERE userid = #{userid} AND topicid = #{topicid}
    </delete>
    <insert id="likereplies">
        insert into news_replies_like (userid,repliesid) values (#{userid},#{repliesid});
    </insert>
    <delete id="unlikereplies">
        DELETE FROM news_replies_like WHERE userid = #{userid} AND repliesid = #{repliesid}
    </delete>
</mapper>
