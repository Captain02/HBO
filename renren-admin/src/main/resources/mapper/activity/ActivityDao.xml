<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ActivityDao">

    <resultMap id="activityPageData" type="io.renren.common.entity.PageData">
        <id column="actid" property="actid"></id>
        <association property="video" column="{id=videoid}" select="FileDao.selectById"/>
        <association property="QRCode" column="{id=fileid}" select="FileDao.selectById"/>
        <association property="enclosureFile" column="{id=enclosure}" select="FileDao.selectById"/>
        <association property="image" column="{id=images}" select="FileDao.selectById"/>
        <association property="corporation" column="actcorid" select="selectCorByCorid"/>
        <association property="actleading" column="{id=actleading}"
                     select="io.renren.modules.sys.dao.SysUserDao.getinfoByid"/>
        <association property="bbs_like" column="actid" select="bbslikeDao.selectLikeByActid"/>
        <association property="bbs_replies" column="actid" select="bbslikeDao.selectRepliesByActid"/>
        <association property="bbs_collection" column="actid" select="bbslikeDao.selectCollectionByActid"/>
        <collection property="processnodes" column="actid" select="ActprocessDao.selectActprocessForActivity"/>
        <collection property="crowdpeople" column="actid" select="selectCrowdPeopleByactId"/>
        <collection property="likePeople" column="actid" select="selectLikePeopleByActId"></collection>
        <collection property="collectionPeople" column="actid" select="selectcollectionPeopleByActId"></collection>
    </resultMap>

    <resultMap id="bbsReplies" type="io.renren.common.entity.PageData">
        <id column="repliesid" property="repliesid"></id>
        <result column="topicid" property="topicid"></result>
        <association property="likeNumber" column="repliesid" select="getLikeNumber"></association>
        <association property="likePeopleDetail" column="{id=userid}"
                     select="io.renren.modules.sys.dao.SysUserDao.getinfoByIdNotContentRoleDept"></association>
        <collection property="likePeopleIds" column="repliesid" select="getlikePeopleIds"></collection>
        <collection property="child" column="{topicid=topicid,repliesid=repliesid}" select="getReplies"></collection>
    </resultMap>

    <resultMap id="activityListPage" type="io.renren.common.entity.PageData">
        <id column="actid" property="actid"></id>
        <result column="actcorid" property="actcorid"></result>
        <association property="video" column="{id=videoid}" select="FileDao.selectById"/>
        <association property="image" column="{id=images}" select="FileDao.selectById"/>
        <association property="corporation" column="actcorid" select="selectCorByCorid"/>
        <association property="actlead" column="{id=actleading}"
                     select="io.renren.modules.sys.dao.SysUserDao.getinfoByIdNotContentRoleDept"/>
        <association property="bbs_like" column="actid" select="bbslikeDao.selectLikeByActid"/>
        <association property="bbs_collection" column="actid" select="bbslikeDao.selectCollectionByActid"/>
        <collection property="processnodes" column="actid" select="ActprocessDao.selectActprocessForActivity"/>
        <collection property="crowdpeople" column="actid" select="selectCrowdPeopleByactId"/>
        <collection property="likePeople" column="actid" select="selectLikePeopleByActId"></collection>
        <collection property="collectionPeople" column="actid" select="selectcollectionPeopleByActId"></collection>
    </resultMap>

    <select id="activitylistPage" resultMap="activityListPage">
        SELECT DISTINCT c.`actname`,c.`actstarttame`,c.`actendtime`,c.`createtime`,c.`actid`,c.`actcorid`,
        c1.`corname`,c.`actleading`,c.`fileid`,c.`videoid`,c.`images`,c.`profile`,c.`enclosure`
        FROM `coractivity` c
        LEFT JOIN `corporation` c1 ON c1.`id` = c.`actcorid`
        LEFT JOIN actcrowd ac ON ac.actid = c.`actid`
        WHERE 1 = 1
        <if test="pd.corid != null and pd.corid!=''">
            AND c1.`id`=#{pd.corid,jdbcType=INTEGER}
        </if>
        <if test="pd.actName!=null and pd.actName!=''">
            AND c.`actname` LIKE CONCAT('%',#{pd.actName,jdbcType=VARCHAR},'%')
        </if>
        <if test="pd.isAct!=null">
            AND c.`isact`=#{pd.isAct,jdbcType=INTEGER}
        </if>
        <if test="pd.actcrowdids != null">
            AND ac.crowdpeople IN
            <foreach collection="pd.actcrowdids" item="item" open="(" close=")" separator=",">
              ${item}
            </foreach>
        </if>
    </select>

    <select id="getActivityById" resultMap="activityPageData">
        SELECT
        `actid`,`actname`,`actstarttame`,`actendtime`,`createtime`,`actdetails`,`actcorid`,`actleading`,
        `fileid`,`videoid`,`images`,`actprocessid`,`profile`,`isact`,`enclosure`
        FROM
        coractivity
        WHERE `actid` = #{actid}
    </select>
    <!--<select id="selectActprocessForActivity" resultType="io.renren.common.entity.PageData">
        SELECT `actid`,`proid`,`processnode`,`states` FROM `actprocess` WHERE actid = #{pd.actId,jdbcType=INTEGER} ORDER BY `proid`
    </select>-->

    <insert id="add" useGeneratedKeys="true" keyProperty="actId">
        insert into `coractivity` (`actname`,`actstarttame`,`actendtime`,`actleading`,`profile`,`actcorid`
        <trim prefix="," suffixOverrides=",">
            <if test="actdetails!=''">
                `actdetails`,
            </if>
            <if test="videoid!=''">
                `videoid`,
            </if>
            <if test="images!=''">
                `images`,
            </if>
            <if test="fileId!=null">
                `fileid`,
            </if>
            <if test="enclosureid != null">
                #{enclosure,jdbcType=INTEGER},
            </if>
        </trim>
        )
        values(#{actName,jdbcType=VARCHAR},
        #{actStartTime,jdbcType=VARCHAR},
        #{actEndTime,jdbcType=VARCHAR},
        #{actLeader,jdbcType=INTEGER},
        #{profile,jdbcType=VARCHAR},#{actCorId,jdbcType=INTEGER}
        <trim prefix="," suffixOverrides=",">
            <if test="actdetails != ''">
                #{actdetails,jdbcType=VARCHAR},
            </if>
            <if test="videoid != ''">
                #{videoid,jdbcType=INTEGER},
            </if>
            <if test="images != ''">
                #{images,jdbcType=INTEGER},
            </if>
            <if test="fileId != null">
                #{fileId,jdbcType=INTEGER},
            </if>
            <if test="enclosureid != null">
                #{enclosureid,jdbcType=INTEGER},
            </if>
        </trim>
        )
    </insert>

    <update id="updateAct">
        update `coractivity`
        <set>
            <if test="actName!=null">
                `actname` = #{actName,jdbcType=VARCHAR},
            </if>
            <if test="actStartTime!=null">
                `actstarttame` = #{actStartTime,jdbcType=VARCHAR},
            </if>
            <if test="actEndTime!=null">
                `actendtime` = #{actEndTime,jdbcType=VARCHAR},
            </if>
            <if test="actdetails!=null">
                `actdetails` = #{actdetails,jdbcType=VARCHAR},
            </if>
            <if test="videoid!=null">
                `videoid` = #{videoid,jdbcType=INTEGER},
            </if>
            <if test="images!=null">
                `images` = #{images,jdbcType=INTEGER},
            </if>
            <if test="fileId!=null">
                `fileid` = #{fileId,jdbcType=VARCHAR},
            </if>
            <if test="profile!=null">
                `profile` = #{profile,jdbcType=VARCHAR},
            </if>
            <if test="enclosureid!=null">
                `enclosureid` = #{enclosureid,jdbcType=VARCHAR},
            </if>
        </set>
        WHERE `actid` = #{actId,jdbcType=INTEGER}
    </update>

    <insert id="addActCroWdPeople">
        INSERT INTO actcrowd (`actid`,`crowdpeople`)
        VALUES
        <foreach collection="list" item="item" separator=",">
            ( #{actId},#{item})
        </foreach>
    </insert>

    <select id="selectCrowdPeopleByactId" resultType="io.renren.common.entity.PageData">
      SELECT sys_dict.`id`,sys_dict.`value`
      FROM sys_dict
      LEFT JOIN actcrowd ON sys_dict.`id` = actcrowd.`crowdpeople`
      WHERE actcrowd.`actid` = #{actid}
    </select>

    <select id="selectCorByCorid" resultType="io.renren.common.entity.PageData">
      SELECT `corname`,`id`
      FROM corporation
      WHERE corporation.`id` = #{actcorid}
    </select>
    <select id="selectLikePeopleByActId" resultType="Long">
        SELECT `userid`
        FROM bbs_like
        WHERE topicid = #{actid}
    </select>
    <select id="getReplieslistPage" resultMap="bbsReplies">
        SELECT `repliesid`,`userid`,`parentid`,`topicid`,`createtime`,`repliescontent`,`states`
        FROM replies
        WHERE `topicid` = #{pd.topicid} AND `parentid` = #{pd.repliesid}
    </select>

    <select id="getReplies" resultMap="bbsReplies">
        SELECT `repliesid`,`userid`,`parentid`,`topicid`,`createtime`,`repliescontent`,`states`
        FROM replies
        WHERE `topicid` = #{topicid} AND `parentid` = #{repliesid}
    </select>

    <select id="getLikeNumber" resultType="Long">
        SELECT count(*) AS num
        FROM bbs_replies_like
        WHERE repliesid = #{repliesid}
    </select>

    <select id="getlikePeopleIds" resultType="Long">
        SELECT `userid`
        FROM bbs_replies_like
        WHERE repliesid = #{repliesid}
    </select>

    <delete id="delActCroWdPeopleByActId">
        DELETE FROM actcrowd
        WHERE actid = #{actid}
    </delete>

    <!--修改进程状态-->
    <select id="selectcollectionPeopleByActId" resultType="Long">
        SELECT `userid`
        FROM bbs_collection
        WHERE topicid = #{actid}
    </select>

    <!--获得报名活动人数-->
    <select id="getUserByActIdlistPage" resultType="io.renren.common.entity.PageData">
      SELECT u.`user_id`,u.`username`,u.`email`,u.`mobile`,u.`persionnum`,u.`wechart`,u.`QQ`,
      u.`fileid`,u.`college`,u.`collegetie`,u.`gender`,u.`descs`,u.`name`,filetable.`id`,filetable.`filepath`
      FROM sys_user u
      LEFT JOIN filetable ON filetable.`id` = u.`fileid`
      LEFT JOIN actenroll ON actenroll.`userid` = u.`user_id`
      WHERE actenroll.`actid` = #{pd.actid} AND actenroll.`actstatusid` = 1
    </select>

    <!--删除点赞-->
    <delete id="delLike">
        DELETE FROM bbs_like
        WHERE userid = #{userid} AND topicid = #{topicid}
    </delete>

    <!--点赞-->
    <insert id="saveLike">
        INSERT INTO bbs_like (userid,topicid) VALUES (#{userid},#{topicid})
    </insert>


</mapper>