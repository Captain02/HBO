<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ActivityDao">

    <resultMap id="activityPageData" type="io.renren.common.entity.PageData">
        <id column="actid" property="actId"></id>
        <collection property="processnodes"
                    column="{actId=actid}" select="ActprocessDao.selectActprocessForActivity">
        </collection>
    </resultMap>

    <select id="activitylistPage" resultMap="activityPageData">
        SELECT c.`actname`,c.`actstarttame`,c.`actendtime`,c.`createtime`,c.`crowdpeople`,c.`actid`,
        c1.`corname`,f.`filepath`,
        COUNT(DISTINCT l.`userid`) likeCount,
        COUNT(DISTINCT c2.`userid`) collectionCount
        FROM `coractivity` c
        LEFT JOIN `corporation` c1 ON c1.`id` = c.`actcorid`
        LEFT JOIN `sys_user` u ON u.`user_id` = c.`actleading`
        LEFT JOIN `filetable` f ON f.`id` = u.`fileid`
        LEFT JOIN `bbs_like` l ON l.`topicid` = c.`actid`
        LEFT JOIN `bbs_collection` c2 ON c2.`topicid` = c.`actcorid`
        <where>
            <if test="pd.corId!=null">
                c1.`id`=#{pd.corId,jdbcType=INTEGER}
            </if>
            <if test="pd.actName!=null and pd.actName!=''">
                AND c.`actname` LIKE CONCAT('%',#{pd.actName,jdbcType=VARCHAR},'%')
            </if>
            <if test="pd.isAct!=null">
                and c.`isact`=#{pd.isAct,jdbcType=INTEGER}
            </if>
        </where>
        GROUP BY c.`actid`
    </select>

    <select id="getActivityById" resultMap="activityPageData">
        SELECT c.`actname`,c.`actstarttame`,c.`actendtime`,c.`createtime`,c.`crowdpeople`,c.`actid`,c.`actdetails`,c.`isact`,
            c1.`corname`,u.`name`,
            f.`filepath` headPath,f.`filename` headName,
            f1.`filepath` codePath,f1.`filename` codeName,
            f2.`filepath` videoPath,f2.`filename` videoName,
            f3.`filepath` imagePath, f3.`filename` imageName,
            COUNT(DISTINCT l.`userid`) likeCount,
            COUNT(DISTINCT c2.`userid`) collectionCount
        FROM `coractivity` c
        LEFT JOIN `corporation` c1 ON c1.`id` = c.`actcorid`
        LEFT JOIN `sys_user` u ON u.`user_id` = c.`actleading`
        LEFT JOIN `filetable` f ON f.`id` = u.`fileid`
        LEFT JOIN `filetable` f1 ON f1.`id` = c.`fileid`
        LEFT JOIN `filetable` f2 ON f2.`id` = c.`videoid`
        LEFT JOIN `filetable` f3 ON f3.`id` = c.`images`
        LEFT JOIN `bbs_like` l ON l.`topicid` = c.`actid`
        LEFT JOIN `bbs_collection` c2 ON c2.`topicid` = c.`actcorid`
        WHERE c.`actid` = #{actId,jdbcType=INTEGER}
        GROUP BY c.`actid`
    </select>
    <!--<select id="selectActprocessForActivity" resultType="io.renren.common.entity.PageData">
        SELECT `actid`,`proid`,`processnode`,`states` FROM `actprocess` WHERE actid = #{pd.actId,jdbcType=INTEGER} ORDER BY `proid`
    </select>-->

    <insert id="add" useGeneratedKeys="true" keyProperty="actId">
        insert into `coractivity` (`actname`,`actstarttame`,`actendtime`,`actleading`,`crowdpeople`,`profile`,`actcorid`
        <trim prefix="," suffixOverrides=",">
            <if test="actDetails!=null">
                `actdetails`,
            </if>
            <if test="videoId!=null">
                `videoid`,
            </if>
            <if test="imageId!=null">
                `images`,
            </if>
            <if test="fileId!=null">
                `fileid`,
            </if>
        </trim>
        )
        values(#{actName,jdbcType=VARCHAR},#{actStartTime,jdbcType=VARCHAR},#{actEndTime,jdbcType=VARCHAR},#{actLeader,jdbcType=INTEGER},
        #{croWdPeople,jdbcType=INTEGER},#{profile,jdbcType=VARCHAR},#{actCorId,jdbcType=INTEGER}
        <trim prefix="," suffixOverrides=",">
            <if test="actDetails!=null">
                #{actDetails,jdbcType=VARCHAR},
            </if>
            <if test="videoId!=null">
                #{videoId,jdbcType=INTEGER},
            </if>
            <if test="imageId!=null">
                #{imageId,jdbcType=INTEGER},
            </if>
            <if test="fileId!=null">
                #{fileId,jdbcType=INTEGER},
            </if>
        </trim>
        )
    </insert>

    <update id="updateAct">
        update `coractivity`
        <set>
            <if test="actName!=null">
                `actname` = #{actName,jdbcType=VARCHAR},
            </if>
            <if test="actStartTime!=null">
                `actstarttame` = #{actStartTime,jdbcType=VARCHAR},
            </if>
            <if test="actEndTime!=null">
                `actendtime` = #{actEndTime,jdbcType=VARCHAR},
            </if>
            <if test="actDetails!=null">
                `actdetails` = #{actDetails,jdbcType=VARCHAR},
            </if>
            <if test="actLeading!=null">
                `actleading` = #{actLeading,jdbcType=INTEGER},
            </if>
            <if test="videoId!=null">
                `videoid` = #{videoId,jdbcType=INTEGER},
            </if>
            <if test="croWdpeople!=null">
                `crowdpeople` = #{croWdpeople,jdbcType=INTEGER},
            </if>
            <if test="images!=null">
                `images` = #{images,jdbcType=INTEGER},
            </if>
            <if test="profile!=null">
                `profile` = #{profile,jdbcType=VARCHAR},
            </if>
            <if test="isact!=null">
                `isact` = #{isact,jdbcType=INTEGER}
            </if>
        </set>
        WHERE `actid` = #{actId,jdbcType=INTEGER}
    </update>
</mapper>