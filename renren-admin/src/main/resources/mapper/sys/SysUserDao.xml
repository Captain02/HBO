<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.sys.dao.SysUserDao">

    <resultMap id="userAll" type="io.renren.common.entity.PageData">
        <id column="user_id" property="user_id"/>
        <result column="username" property="username"/>
        <result column="email" property="email"/>
        <result column="mobile" property="mobile"/>
        <result column="create_time" property="create_time"/>
        <result column="persionnum" property="persionnum"/>
        <result column="wechart" property="wechart"/>
        <result column="QQ" property="QQ"/>
        <result column="college" property="college"/>
        <result column="collegetie" property="collegetie"/>
        <result column="gender" property="gender"/>
        <result column="descs" property="descs"/>
        <result column="filetable" property="filetable"/>
        <result column="filename" property="filename"/>
        <result column="filetable" property="filetable"/>
        <result column="filepath" property="filepath"/>
        <result column="usercorid" property="corid"/>
        <result column="fileid" property="fileid"/>
        <collection property="roles" select="selectRoleByUserRole" column="{user_id=user_id,corid=corid}"></collection>
        <collection property="depts" select="selectDeptByUserRole" column="{user_id=user_id,corid=corid}"></collection>
    </resultMap>

    <sql id="user_sql">
		sys_user.user_id,sys_user.username,sys_user.email,
		sys_user.mobile,sys_user.create_time,sys_user.persionnum,sys_user.wechart,sys_user.QQ,sys_user.college,
		sys_user.collegetie,sys_user.gender,sys_user.descs,filetable.filename,filetable.filepath,sys_user.salt,sys_user.`name`,
		sys_user.fileid
	</sql>

    <!--根据社团ID和用户名查询用户信息基本-->
    <select id="selectUserByUsernameCorporaition" resultType="io.renren.modules.sys.entity.SysUserEntity">
		SELECT
		`user_id`,`username`,`password`,`salt`,cor_user.`status`,`openid`
		FROM
		sys_user
		LEFT JOIN cor_user ON cor_user.userid = sys_user.user_id
		WHERE sys_user.username=#{username}
		AND cor_user.corid = #{corid}
	</select>

    <!--修改用户-->
    <update id="updateUserByid">
		  UPDATE sys_user SET email = #{email},mobile = #{mobile},wechart = #{wechart},QQ = #{qq},
		  college = #{college},collegetie = #{collegetie},gender=#{gender},descs=#{descs},`name`=#{name}
		  WHERE user_id = #{userId}
	</update>

    <!-- 查询用户的所有权限 -->
    <select id="queryAllPerms" resultType="string">
		SELECT DISTINCT IFNULL(m.perms,'') FROM sys_menu m
        LEFT JOIN sys_role_menu rm ON rm.`menu_id` = m.`menu_id`
        LEFT JOIN sys_user_role ur ON ur.`role_id` = rm.`role_id`
		WHERE ur.user_id = #{userId}
		AND ur.`corid`= #{corid}
	</select>

    <!-- 查询用户的所有菜单ID -->
    <select id="queryAllMenuId" resultType="long">
		SELECT DISTINCT rm.menu_id FROM sys_user_role ur
			LEFT JOIN sys_role_menu rm ON ur.role_id = rm.role_id
			LEFT JOIN sys_role ON sys_role.`role_id` = rm.`role_id`
		WHERE ur.user_id = #{userid} AND sys_role.corid =#{corid}
	</select>

    <select id="geUserPassword" resultType="String">
		SELECT `password` FROM sys_user WHERE `username` = #{pagedate.username}
	</select>

    <!--List<PageData> list = (List<PageData>) daoSupport.
                findForList("io.renren.modules.sys.dao.SysUserDao.userlistPage",page);-->
    <select resultType="io.renren.common.entity.PageData" id="userlistPage">
        SELECT
        DISTINCT
        <include refid="user_sql"></include>
        FROM sys_user
        LEFT JOIN filetable ON filetable.id = sys_user.fileid
        LEFT JOIN cor_user ON cor_user.userid = sys_user.user_id
        LEFT JOIN sys_user_dept ON sys_user_dept.deptid = sys_user.user_id
        LEFT JOIN sys_dept ON sys_dept.dept_id = sys_user_dept.deptid
        WHERE cor_user.status = 1
        AND cor_user.corid = #{pd.corid}
        <if test="name != null">
            AND sys_user.`name` = #{pd.name}
        </if>
        <if test="persionnum != null">
            AND sys_user.`username` = #{pd.username}
        </if>
    </select>

    <!--void removeUserByIds(List<Long> collect, Long corid);-->
    <!--删除社团成员-->
    <update id="removeUserByIds" parameterType="java.util.List">
        UPDATE cor_user SET status = 0
        WHERE corid = #{corid} AND userid IN
        <foreach collection="list" index="index" item="ids" open="(" separator="," close=")">
            #{ids}
        </foreach>
    </update>

    <!--
    PageData forObject = (PageData) daoSupport.findForObject("io.renren.modules.sys.dao.SysUserDao.getinfoByid", pageData);
    -->
    <select id="getinfoByid" resultMap="userAll">
        SELECT
        <include refid="user_sql"></include>,
        filetable.`filepath` headpath,#{corid} corid
        FROM sys_user
        LEFT JOIN filetable ON filetable.id = sys_user.fileid
        WHERE user_id = #{id}
    </select>

    <select id="selectRoleByUserRole" resultType="io.renren.common.entity.PageData">
		SELECT sys_role.role_id,role_name,remark,sys_role.create_time,sys_role.corid rolecorid
		FROM sys_role
		LEFT JOIN sys_user_role ON sys_user_role.role_id = sys_role.role_id
		WHERE
		sys_user_role.user_id = #{user_id}
		AND sys_role.corid = #{corid}
	</select>

    <select id="selectDeptByUserRole" resultType="io.renren.common.entity.PageData">
		SELECT dept_id,parent_id,`name`,order_num,del_flag,sys_dept.corid deptcorid
		FROM sys_dept
		LEFT JOIN sys_user_dept ON sys_user_dept.deptid = sys_dept.dept_id
		WHERE
		sys_user_dept.userid = #{user_id}
		AND sys_dept.corid = #{corid}
	</select>

    <!--saveUserCor-->
    <insert id="saveUserCor">
		INSERT INTO cor_user (userid,corid,status)VALUES (#{userid},#{corid},1)
	</insert>

    <!--扫码添加-->
    <insert id="QRsaveUserCor">
        INSERT INTO cor_user (userid,corid)VALUES (#{userid},#{corid})
    </insert>
    <!--查询用户是
    否有部门-->
    <select id="selectUserDept" resultType="io.renren.common.entity.PageData">
		SELECT count(*) num FROM sys_user_dept WHERE userid = #{user_id} AND corid=#{corid}
	</select>

    <!--修改用户部门-->
    <update id="updateUserDept">
		UPDATE sys_user_dept SET deptid = #{dept_id} WHERE userid = #{user_id} AND corid=#{corid}
	</update>

    <!--保存用户部门-->
    <insert id="saveUserDept">
		insert into sys_user_dept (deptid,userid,corid) values (#{dept_id},#{user_id},#{corid});
	</insert>

    <!--上传头像-->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        insert into filetable(`filename`,`filepath`) values (#{fileName},#{url})
	</insert>

    <!--扫码注册-->
    <insert id="QRSave" useGeneratedKeys="true" keyProperty="user_id">
        INSERT INTO sys_user
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="username !=null">
                `username`,
            </if>
            <if test="password !=null">
                `password`,
            </if>
            <if test="salt !=null">
                `salt`,
            </if>
            <if test="email !=null">
                `email`,
            </if>
            <if test="mobile !=null">
                `mobile`,
            </if>
            <if test="status !=null">
                `status`,
            </if>
            <if test="wechart !=null">
                `wechart`,
            </if>
            <if test="QQ !=null">
                `QQ`,
            </if>
            <if test="college !=null">
                `college`,
            </if>
            <if test="collegetie !=null">
                `collegetie`,
            </if>
            <if test="gender !=null">
                `gender`,
            </if>
            <if test="openid !=null">
                `openid`,
            </if>
            <if test="descs !=null">
                `descs`,
            </if>
            <if test="name !=null">
                `name`,
            </if>
            <if test="fileid !=null">
                `fileid`,
            </if>
            <if test="persionnum !=null">
                `persionnum`,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="username !=null">
                #{username},
            </if>
            <if test="password !=null">
                #{password},
            </if>
            <if test="salt !=null">
                #{salt},
            </if>
            <if test="email !=null">
                #{email},
            </if>
            <if test="mobile !=null">
                #{mobile},
            </if>
            <if test="status !=null">
                #{status},
            </if>
            <if test="wechart !=null">
                #{wechart},
            </if>
            <if test="QQ !=null">
                #{QQ},
            </if>
            <if test="college !=null">
                #{college},
            </if>
            <if test="collegetie !=null">
                #{collegetie},
            </if>
            <if test="gender !=null">
                #{gender},
            </if>
            <if test="openid !=null">
                #{openid},
            </if>
            <if test="descs !=null">
                #{descs},
            </if>
            <if test="name !=null">
                #{name},
            </if>
            <if test="fileid !=null">
                #{fileid},
            </if>
            <if test="persionnum !=null">
                #{persionnum},
            </if>
        </trim>
    </insert>

    <!--修改用户基本信息-->
    <update id="updateUserInfo">
          UPDATE sys_user
          <set>
              <if test="userName!=null and userName!=''">
                  `username`=#{userName,jdbcType=VARCHAR},
              </if>
              <if test="email!=null and email!=''">
                  `email`=#{email,jdbcType=VARCHAR},
              </if>
              <if test="mobile!=null and mobile!=''">
                  `mobile`=#{mobile,jdbcType=VARCHAR},
              </if>
              <if test="persionNum!=null and persionNum!=''">
                  `persionnum`=#{persionNum,jdbcType=VARCHAR},
              </if>
              <if test="wechart!=null and wechart!=''">
                  `wechart`=#{wechart,jdbcType=VARCHAR},
              </if>
              <if test="QQ!=null and QQ!=''">
                  `QQ`=#{QQ,jdbcType=VARCHAR},
              </if>
              <if test="fileId!=null">
                  `fileid`=#{fileId,jdbcType=INTEGER},
              </if>
              <if test="college!=null and college!=''">
                  `college`=#{college,jdbcType=VARCHAR},
              </if>
              <if test="collegetie!=null and collegetie!=''">
                  `collegetie`=#{collegetie,jdbcType=VARCHAR},
              </if>
              <if test="descs!=null and descs!=''">
                  `descs`=#{descs,jdbcType=VARCHAR},
              </if>
              <if test="name!=null and name!=''">
                  `name`=#{name,jdbcType=VARCHAR},
              </if>
          </set>
		  WHERE user_id = #{userId,jdbcType=INTEGER}
    </update>

    <!--selectUserByUsername-->
    <select id="selectUserByUsername" resultMap="userAll">
        SELECT
        <include refid="user_sql"></include>,
        filetable.`filepath` headpath,#{corid} corid
        FROM sys_user
        LEFT JOIN filetable ON filetable.id = sys_user.fileid
        WHERE username = #{username}
    </select>

    <delete id="delChatHead">
        DELETE FROM filetable WHERE id = #{id,jdbcType=INTEGER}
    </delete>

    <!--添加用户角色-->
    <insert id="insertUserRole">
		insert into sys_user_role (user_id,role_id,corid) values (#{user_id},#{role_id},#{corid});
	</insert>

    <!--删除用户角色-->
    <delete id="deleUserRole">
		DELETE FROM sys_user_role WHERE user_id = #{user_id} AND role_id = #{role_id} AND corid = #{corid}
	</delete>

    <!--获取角色所有权限-->
    <select id="getUserPermission" resultType="io.renren.common.entity.PageData">
        SELECT DISTINCT IFNULL(m.perms,''),m.`name`,m.`url`,m.`perms`,
        m.`type`,m.`icon`,m.`order_num`,m.`hidden`,m.`title`,m.`redirect`,
        m.`always_show`,m.`use_cache`,m.`query`,m.`menu_id` FROM sys_menu m
        LEFT JOIN sys_role_menu rm ON rm.`menu_id` = m.`menu_id`
		WHERE rm.role_id = #{roleid}
    </select>

    <!--根据openid获得用户信息-->
    <select id="selectByOpenid" resultType="io.renren.common.entity.PageData">
        SELECT user_id , username FROM sys_user WHERE openid = #{openid}
    </select>

    <!--扫码添加社团成员-->
    <insert id="insertUserCor">
        INSERT INTO sys_user (userid,corid) VALUES (#{userid},#{corid})
    </insert>

    <!--查询属于的社团-->
    <select id="selectCorByUserCorid" resultType="io.renren.common.entity.PageData">
      select corporation.id from corporation
      LEFT JOIN cor_user ON cor_user.corid = corporation.id
      LEFT JOIN sys_user ON sys_user.user_id = cor_user.userid
      WHERE cor_user.corid = #{corid}
        <choose>
            <when test="userid != null ">
                AND cor_user.userid=#{userid}
            </when >
            <when test="username != null ">
                AND sys_user.username=#{username}
            </when >
        </choose>
    </select>

    <!--查询用户拥有的社团-->
    <select id="getUserCorsByUserName" resultType="io.renren.common.entity.PageData">
        select corporation.id,corporation.corname from corporation
      LEFT JOIN cor_user ON cor_user.corid = corporation.id
      LEFT JOIN sys_user ON sys_user.user_id = cor_user.userid
      WHERE sys_user.`username`=#{username}
    </select>

    <!--查询学号是否存在-->
    <select id="selectCountByUserName" resultType="Long">
        SELECT COUNT(*) FROM sys_user
        WHERE sys_user.`username` = #{username}
    </select>
</mapper>